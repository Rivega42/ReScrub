import { useState } from 'react';
import { useQuery, useMutation } from '@tanstack/react-query';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  Table, 
  TableBody, 
  TableCell, 
  TableHead, 
  TableHeader, 
  TableRow 
} from "@/components/ui/table";
import { 
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { 
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue 
} from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { 
  FileText, 
  Settings, 
  Play, 
  Pause, 
  RefreshCw, 
  Calendar,
  Eye,
  Edit,
  Trash2,
  Plus,
  Bot,
  Clock,
  TrendingUp
} from "lucide-react";
import { useToast } from '@/hooks/use-toast';
import { apiRequest } from '@/lib/queryClient';
import { queryClient } from '@/lib/queryClient';
import { format } from 'date-fns';
import { ru } from 'date-fns/locale';

interface BlogArticle {
  id: string;
  title: string;
  slug: string;
  content: string;
  excerpt?: string;
  category: string;
  tags: string[];
  status: string;
  publishedAt?: string;
  generatedBy?: string;
  authorName?: string;
  readingTime?: number;
  isAutoGenerated: boolean;
  featured: boolean;
  viewCount: number;
  createdAt: string;
  updatedAt: string;
}

interface BlogGenerationSettings {
  id: string;
  isEnabled: boolean;
  frequency: string;
  maxArticlesPerDay: number;
  articleTypes: string[];
  topics: string[];
  contentLength: string;
  targetAudience: string;
  writingStyle: string;
  seoOptimized?: boolean;
  includeStats?: boolean;
  includeStepByStep?: boolean;
  includeRussianLaw?: boolean;
  includeBrokerLists?: boolean;
  lastGeneratedAt?: string;
  nextGenerationAt?: string;
  generationHistory?: any[];
  createdAt?: string;
  updatedAt?: string;
}

interface SchedulerStatus {
  isRunning: boolean;
  lastRun: string | null;
  nextRun: string | null;
  totalGenerated: number;
  errors: number;
}

export default function AdminBlog() {
  const { toast } = useToast();
  const [selectedArticle, setSelectedArticle] = useState<BlogArticle | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  // Queries
  const { data: articles, isLoading: articlesLoading } = useQuery({
    queryKey: ['/api/admin/blog/articles'],
  });

  const { data: settings, isLoading: settingsLoading } = useQuery({
    queryKey: ['/api/admin/blog/settings'],
  });

  const { data: schedulerStatus, isLoading: statusLoading } = useQuery({
    queryKey: ['/api/admin/blog/scheduler/status'],
    refetchInterval: 30000, // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  });

  // Mutations
  const generateMutation = useMutation({
    mutationFn: async () => {
      const response = await apiRequest('POST', '/api/admin/blog/generate');
      return await response.json();
    },
    onSuccess: () => {
      toast({
        title: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞',
        description: '–ù–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è',
      });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/blog/articles'] });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/blog/scheduler/status'] });
    },
    onError: () => {
      toast({
        title: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏',
        description: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ç–∞—Ç–µ–π',
        variant: 'destructive',
      });
    },
  });

  const updateSettingsMutation = useMutation({
    mutationFn: async (newSettings: Partial<BlogGenerationSettings>) => {
      const response = await apiRequest('PATCH', '/api/admin/blog/settings', newSettings);
      return await response.json();
    },
    onSuccess: () => {
      toast({
        title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
        description: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/blog/settings'] });
    },
  });

  const deleteArticleMutation = useMutation({
    mutationFn: async (articleId: string) => {
      const response = await apiRequest('DELETE', `/api/admin/blog/articles/${articleId}`);
      return await response.json();
    },
    onSuccess: () => {
      toast({
        title: '–°—Ç–∞—Ç—å—è —É–¥–∞–ª–µ–Ω–∞',
        description: '–°—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–ª–æ–≥–∞',
      });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/blog/articles'] });
    },
  });

  const publishArticleMutation = useMutation({
    mutationFn: async ({ articleId, status }: { articleId: string; status: string }) => {
      const response = await apiRequest('PATCH', `/api/admin/blog/articles/${articleId}`, { status });
      return await response.json();
    },
    onSuccess: () => {
      toast({
        title: '–°—Ç–∞—Ç—å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
        description: '–°—Ç–∞—Ç—É—Å —Å—Ç–∞—Ç—å–∏ –∏–∑–º–µ–Ω–µ–Ω',
      });
      queryClient.invalidateQueries({ queryKey: ['/api/admin/blog/articles'] });
    },
  });

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'published': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
      case 'draft': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
      case 'archived': return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'published': return '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ';
      case 'draft': return '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      case 'archived': return '–ê—Ä—Ö–∏–≤';
      default: return status;
    }
  };

  if (articlesLoading || settingsLoading || statusLoading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold" data-testid="text-admin-blog-title">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–≥–æ–º
          </h1>
          <p className="text-muted-foreground">
            –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—å—è–º–∏ –±–ª–æ–≥–∞ ResCrub
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            onClick={() => generateMutation.mutate()}
            disabled={generateMutation.isPending}
            data-testid="button-generate-article"
          >
            <Bot className="h-4 w-4 mr-2" />
            {generateMutation.isPending ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...' : '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é'}
          </Button>
          <Button variant="outline" data-testid="button-create-article">
            <Plus className="h-4 w-4 mr-2" />
            –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç—å—é
          </Button>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">–í—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π</CardTitle>
            <FileText className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{(articles as any)?.length || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {Array.isArray(articles) ? articles.filter((a: BlogArticle) => a.status === 'published').length : 0}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –ò–ò</CardTitle>
            <Bot className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{(schedulerStatus as any)?.totalGenerated || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">–°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞</CardTitle>
            <Clock className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <div className={`h-2 w-2 rounded-full ${(schedulerStatus as any)?.isRunning ? 'bg-green-500' : 'bg-red-500'}`} />
              <span className="text-sm">{(schedulerStatus as any)?.isRunning ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Main Content */}
      <Tabs defaultValue="articles" className="space-y-4">
        <TabsList>
          <TabsTrigger value="articles">–°—Ç–∞—Ç—å–∏</TabsTrigger>
          <TabsTrigger value="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</TabsTrigger>
          <TabsTrigger value="scheduler">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</TabsTrigger>
        </TabsList>

        {/* Articles Tab */}
        <TabsContent value="articles" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>–°—Ç–∞—Ç—å–∏ –±–ª–æ–≥–∞</CardTitle>
            </CardHeader>
            <CardContent>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>–ó–∞–≥–æ–ª–æ–≤–æ–∫</TableHead>
                    <TableHead>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</TableHead>
                    <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                    <TableHead>–ê–≤—Ç–æ—Ä</TableHead>
                    <TableHead>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</TableHead>
                    <TableHead>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</TableHead>
                    <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {Array.isArray(articles) ? articles.map((article: BlogArticle) => (
                    <TableRow key={article.id}>
                      <TableCell className="font-medium">
                        <div className="flex items-center gap-2">
                          {article.featured && (
                            <Badge variant="secondary" className="text-xs">TOP</Badge>
                          )}
                          {article.isAutoGenerated && (
                            <Bot className="h-3 w-3 text-muted-foreground" />
                          )}
                          <span className="truncate max-w-[300px]">{article.title}</span>
                        </div>
                      </TableCell>
                      <TableCell>
                        <Badge variant="outline">{article.category}</Badge>
                      </TableCell>
                      <TableCell>
                        <Badge className={getStatusColor(article.status)}>
                          {getStatusText(article.status)}
                        </Badge>
                      </TableCell>
                      <TableCell className="text-sm text-muted-foreground">
                        {article.authorName || 'ResCrub AI'}
                      </TableCell>
                      <TableCell className="text-sm text-muted-foreground">
                        {format(new Date(article.createdAt), 'dd.MM.yyyy HH:mm', { locale: ru })}
                      </TableCell>
                      <TableCell className="text-sm">
                        {article.viewCount || 0}
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-1">
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => window.open(`/blog/${article.slug}`, '_blank')}
                            data-testid={`button-view-${article.id}`}
                          >
                            <Eye className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => setSelectedArticle(article)}
                            data-testid={`button-edit-${article.id}`}
                          >
                            <Edit className="h-4 w-4" />
                          </Button>
                          {article.status === 'draft' && (
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => publishArticleMutation.mutate({ 
                                articleId: article.id, 
                                status: 'published' 
                              })}
                              data-testid={`button-publish-${article.id}`}
                            >
                              <Play className="h-4 w-4" />
                            </Button>
                          )}
                          <AlertDialog>
                            <AlertDialogTrigger asChild>
                              <Button
                                variant="ghost"
                                size="sm"
                                data-testid={`button-delete-${article.id}`}
                              >
                                <Trash2 className="h-4 w-4" />
                              </Button>
                            </AlertDialogTrigger>
                            <AlertDialogContent>
                              <AlertDialogHeader>
                                <AlertDialogTitle>–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?</AlertDialogTitle>
                                <AlertDialogDescription>
                                  –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –°—Ç–∞—Ç—å—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞.
                                </AlertDialogDescription>
                              </AlertDialogHeader>
                              <AlertDialogFooter>
                                <AlertDialogCancel>–û—Ç–º–µ–Ω–∞</AlertDialogCancel>
                                <AlertDialogAction
                                  onClick={() => deleteArticleMutation.mutate(article.id)}
                                  className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                                >
                                  –£–¥–∞–ª–∏—Ç—å
                                </AlertDialogAction>
                              </AlertDialogFooter>
                            </AlertDialogContent>
                          </AlertDialog>
                        </div>
                      </TableCell>
                    </TableRow>
                  )) : null}
                </TableBody>
              </Table>

              {!Array.isArray(articles) || articles.length === 0 && (
                <div className="text-center py-8 text-muted-foreground">
                  <FileText className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>–°—Ç–∞—Ç—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                  <p className="text-sm">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å—Ç–∞—Ç—å—é –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é</p>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Settings Tab */}
        <TabsContent value="settings" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</CardTitle>
              <p className="text-sm text-muted-foreground">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–µ–π
              </p>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="flex items-center justify-between">
                <div className="space-y-0.5">
                  <Label>–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞</Label>
                  <p className="text-sm text-muted-foreground">
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
                  </p>
                </div>
                <Switch
                  checked={(settings as any)?.isEnabled || false}
                  onCheckedChange={(checked) =>
                    updateSettingsMutation.mutate({ isEnabled: checked })
                  }
                  data-testid="switch-auto-generation"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>–ß–∞—Å—Ç–æ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</Label>
                  <Select
                    value={(settings as any)?.frequency || 'daily'}
                    onValueChange={(value) =>
                      updateSettingsMutation.mutate({ frequency: value })
                    }
                  >
                    <SelectTrigger data-testid="select-frequency">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="hourly">–ö–∞–∂–¥—ã–π —á–∞—Å</SelectItem>
                      <SelectItem value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</SelectItem>
                      <SelectItem value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>–ú–∞–∫—Å–∏–º—É–º —Å—Ç–∞—Ç–µ–π –≤ –¥–µ–Ω—å</Label>
                  <Input
                    type="number"
                    min="1"
                    max="10"
                    value={(settings as any)?.maxArticlesPerDay || 3}
                    onChange={(e) =>
                      updateSettingsMutation.mutate({ 
                        maxArticlesPerDay: parseInt(e.target.value) 
                      })
                    }
                    data-testid="input-max-articles"
                  />
                </div>
              </div>

              {/* –ù–û–í–û–ï: –¢–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞–∫ —É Incogni.com */}
              <div className="space-y-4 border-t pt-6">
                <h3 className="text-lg font-semibold text-primary">–¢–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ –æ–±—Ä–∞–∑—Ü—É Incogni.com)</h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>–¢–∏–ø —Å—Ç–∞—Ç—å–∏</Label>
                    <Select
                      value={(settings as any)?.articleTypes?.[0] || 'research'}
                      onValueChange={(value) =>
                        updateSettingsMutation.mutate({ 
                          articleTypes: [value] // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω —Ç–∏–ø, –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
                        })
                      }
                    >
                      <SelectTrigger data-testid="select-article-type">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="research">üî¨ Research articles (–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ)</SelectItem>
                        <SelectItem value="opt-out-guide">üìã Opt-out guides (–ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)</SelectItem>
                        <SelectItem value="privacy-guide">üõ°Ô∏è Privacy guides (—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏)</SelectItem>
                        <SelectItem value="spam-protection">üö´ How to stop spam (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)</SelectItem>
                        <SelectItem value="law-guide">‚öñÔ∏è 152-–§–ó guides (—Ä–æ—Å—Å–∏–π—Å–∫–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label>–°—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è</Label>
                    <Select
                      value={(settings as any)?.writingStyle || 'informational'}
                      onValueChange={(value) =>
                        updateSettingsMutation.mutate({ writingStyle: value })
                      }
                    >
                      <SelectTrigger data-testid="select-writing-style">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="informational">üì∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π</SelectItem>
                        <SelectItem value="tutorial">üéì –û–±—É—á–∞—é—â–∏–π</SelectItem>
                        <SelectItem value="academic">üéØ –ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π</SelectItem>
                        <SelectItem value="conversational">üí¨ –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π</SelectItem>
                        <SelectItem value="legal">‚öñÔ∏è –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label>–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</Label>
                    <Select
                      value={(settings as any)?.targetAudience || 'citizens'}
                      onValueChange={(value) =>
                        updateSettingsMutation.mutate({ targetAudience: value })
                      }
                    >
                      <SelectTrigger data-testid="select-target-audience">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="citizens">üë• –ì—Ä–∞–∂–¥–∞–Ω–µ</SelectItem>
                        <SelectItem value="lawyers">‚öñÔ∏è –Æ—Ä–∏—Å—Ç—ã</SelectItem>
                        <SelectItem value="it-professionals">üíª IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã</SelectItem>
                        <SelectItem value="business">üè¢ –ë–∏–∑–Ω–µ—Å</SelectItem>
                        <SelectItem value="students">üéì –°—Ç—É–¥–µ–Ω—Ç—ã</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label>–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</Label>
                    <Select
                      value={(settings as any)?.contentLength || 'medium'}
                      onValueChange={(value) =>
                        updateSettingsMutation.mutate({ contentLength: value })
                      }
                    >
                      <SelectTrigger data-testid="select-content-length">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="brief">üìù –ö—Ä–∞—Ç–∫–∏–µ (500-1000 —Å–ª–æ–≤)</SelectItem>
                        <SelectItem value="short">üìÑ –ö–æ—Ä–æ—Ç–∫–∏–µ (1000-1500 —Å–ª–æ–≤)</SelectItem>
                        <SelectItem value="medium">üìö –°—Ä–µ–¥–Ω–∏–µ (1500-2500 —Å–ª–æ–≤)</SelectItem>
                        <SelectItem value="detailed">üìñ –ü–æ–¥—Ä–æ–±–Ω—ã–µ (2500-3500 —Å–ª–æ–≤)</SelectItem>
                        <SelectItem value="comprehensive">üìï –ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–µ (3500+ —Å–ª–æ–≤)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
                <div className="space-y-3 border-t pt-4">
                  <h4 className="font-medium text-sm">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h4>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-sm">–ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</Label>
                        <p className="text-xs text-muted-foreground">
                          –í–∫–ª—é—á–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ—à–∞–≥–æ–≤—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
                        </p>
                      </div>
                      <Switch
                        checked={(settings as any)?.includeStepByStep || false}
                        onCheckedChange={(checked) =>
                          updateSettingsMutation.mutate({ includeStepByStep: checked })
                        }
                        data-testid="switch-step-by-step"
                      />
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-sm">–†–æ—Å—Å–∏–π—Å–∫–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ</Label>
                        <p className="text-xs text-muted-foreground">
                          –°—Å—ã–ª–∫–∏ –Ω–∞ 152-–§–ó –∏ –¥—Ä—É–≥–∏–µ –Ω–æ—Ä–º—ã –†–§
                        </p>
                      </div>
                      <Switch
                        checked={(settings as any)?.includeRussianLaw || false}
                        onCheckedChange={(checked) =>
                          updateSettingsMutation.mutate({ includeRussianLaw: checked })
                        }
                        data-testid="switch-russian-law"
                      />
                    </div>

                    <div className="flex items-center justify-between">
                      <div className="space-y-0.5">
                        <Label className="text-sm">–°–ø–∏—Å–∫–∏ –±—Ä–æ–∫–µ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö</Label>
                        <p className="text-xs text-muted-foreground">
                          –í–∫–ª—é—á–∞—Ç—å —Å–ø–∏—Å–∫–∏ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Å–∞–π—Ç–æ–≤-–±—Ä–æ–∫–µ—Ä–æ–≤
                        </p>
                      </div>
                      <Switch
                        checked={(settings as any)?.includeBrokerLists || false}
                        onCheckedChange={(checked) =>
                          updateSettingsMutation.mutate({ includeBrokerLists: checked })
                        }
                        data-testid="switch-broker-lists"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <Label>–¢–µ–º—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</Label>
                <Textarea
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é..."
                  value={(settings as any)?.topics?.join(', ') || ''}
                  onChange={(e) =>
                    updateSettingsMutation.mutate({ 
                      topics: e.target.value.split(',').map(t => t.trim()).filter(Boolean)
                    })
                  }
                  data-testid="textarea-topics"
                  className="min-h-[100px]"
                />
                <p className="text-sm text-muted-foreground">
                  –¢–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –±–∞–∑–æ–π –∫–∞–∫ —É Incogni.com: —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –±—Ä–æ–∫–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
                </p>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Scheduler Tab */}
        <TabsContent value="scheduler" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>–°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞</CardTitle>
              <p className="text-sm text-muted-foreground">
                –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
              </p>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-4 border rounded-lg">
                    <div>
                      <p className="font-medium">–°—Ç–∞—Ç—É—Å</p>
                      <p className="text-sm text-muted-foreground">
                        {(schedulerStatus as any)?.isRunning ? '–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω' : '–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
                      </p>
                    </div>
                    <div className={`h-3 w-3 rounded-full ${(schedulerStatus as any)?.isRunning ? 'bg-green-500' : 'bg-red-500'}`} />
                  </div>

                  <div className="p-4 border rounded-lg">
                    <p className="font-medium">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫</p>
                    <p className="text-sm text-muted-foreground">
                      {(schedulerStatus as any)?.lastRun 
                        ? format(new Date((schedulerStatus as any).lastRun), 'dd.MM.yyyy HH:mm', { locale: ru })
                        : '–ù–∏–∫–æ–≥–¥–∞'
                      }
                    </p>
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="p-4 border rounded-lg">
                    <p className="font-medium">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫</p>
                    <p className="text-sm text-muted-foreground">
                      {(schedulerStatus as any)?.nextRun 
                        ? format(new Date((schedulerStatus as any).nextRun), 'dd.MM.yyyy HH:mm', { locale: ru })
                        : '–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω'
                      }
                    </p>
                  </div>

                  <div className="p-4 border rounded-lg">
                    <p className="font-medium">–û—à–∏–±–∫–∏</p>
                    <p className="text-sm text-muted-foreground">
                      {(schedulerStatus as any)?.errors || 0} –æ—à–∏–±–æ–∫
                    </p>
                  </div>
                </div>
              </div>

              <div className="flex gap-2">
                <Button
                  onClick={() => generateMutation.mutate()}
                  disabled={generateMutation.isPending}
                  data-testid="button-force-generation"
                >
                  <RefreshCw className="h-4 w-4 mr-2" />
                  {generateMutation.isPending ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å'}
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}