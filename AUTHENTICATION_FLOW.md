# üîê –°–ò–°–¢–ï–ú–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ò –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò - –¢–ï–ö–£–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏](#–ø—Ä–æ—Ü–µ—Å—Å-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
3. [–ü—Ä–æ—Ü–µ—Å—Å –≤—Ö–æ–¥–∞](#–ø—Ä–æ—Ü–µ—Å—Å-–≤—Ö–æ–¥–∞)
4. [Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è](#email-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è)
5. [OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è](#oauth-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
6. [Session management](#session-management)
7. [–ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤](#–∑–∞—â–∏—Ç–∞-—Ä–æ—É—Ç–æ–≤)
8. [Database —Å—Ö–µ–º–∞](#database-—Å—Ö–µ–º–∞)
9. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## üéØ –û–ë–ó–û–† –°–ò–°–¢–ï–ú–´

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ResCrub –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–¥–≤–µ —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**:

1. **Email/Password –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** (–æ—Å–Ω–æ–≤–Ω–∞—è)
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ email
   - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email –∞–¥—Ä–µ—Å–∞
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (bcrypt)
   - Session-based –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

2. **OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã** (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è)
   - VK ID
   - Yandex ID
   - Replit Auth
   - Sberbank ID (–≥–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
   - Tinkoff ID (–≥–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
   - ESIA –ì–æ—Å—É—Å–ª—É–≥–∏ (–≥–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND (React)                      ‚îÇ
‚îÇ  - AuthContext (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)                   ‚îÇ
‚îÇ  - Login/Register —Å—Ç—Ä–∞–Ω–∏—Ü—ã                               ‚îÇ
‚îÇ  - Protected routes                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  BACKEND (Express.js)                    ‚îÇ
‚îÇ  - Rate limiters (–∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞)                  ‚îÇ
‚îÇ  - Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö)                      ‚îÇ
‚îÇ  - bcrypt —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (12 rounds)                       ‚îÇ
‚îÇ  - Session middleware (express-session)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              DATABASE (PostgreSQL + Drizzle ORM)         ‚îÇ
‚îÇ  - userAccounts (email, passwordHash)                   ‚îÇ
‚îÇ  - userProfiles (–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)                     ‚îÇ
‚îÇ  - sessions (session store)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                EMAIL SERVICE (Mailganer.ru)              ‚îÇ
‚îÇ  - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email                                     ‚îÇ
‚îÇ  - –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è                                          ‚îÇ
‚îÇ  - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù –ü–†–û–¶–ï–°–° –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

### –®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É

**Frontend (`client/src/pages/register.tsx`):**
```typescript
const form = useForm({
  resolver: zodResolver(registerSchema),
  defaultValues: {
    email: "",
    password: "",
    confirmPassword: ""
  }
});
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:**
- Email: —Ñ–æ—Ä–º–∞—Ç email –∞–¥—Ä–µ—Å–∞
- –ü–∞—Ä–æ–ª—å: –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è: —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–∞—Ä–æ–ª–µ–º

### –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**POST `/api/auth/register`**

**Rate Limiting:**
- –ú–∞–∫—Å–∏–º—É–º 3 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –æ–¥–Ω–æ–≥–æ IP –≤ —á–∞—Å
- –ó–∞—â–∏—Ç–∞ –æ—Ç –º–∞—Å—Å–æ–≤—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –±–æ—Ç–∞–º–∏

### –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**Backend (`server/routes.ts`):**
```typescript
// Zod —Å—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const registerSchema = insertUserAccountSchema
  .extend({
    password: z.string()
      .min(8, '–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤')
      .max(128, '–ú–∞–∫—Å–∏–º—É–º 128 —Å–∏–º–≤–æ–ª–æ–≤')
  });

const validatedData = registerSchema.parse(req.body);
```

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ Email —Ñ–æ—Ä–º–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ Email —É–Ω–∏–∫–∞–ª–µ–Ω (–Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
- ‚úÖ –ü–∞—Ä–æ–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

### –®–∞–≥ 4: –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è

```typescript
import bcrypt from 'bcryptjs';

// 12 rounds - –∑–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
const passwordHash = await bcrypt.hash(validatedData.password, 12);
```

**–í—Ä–µ–º—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:** ~200ms
**–í—Ä–µ–º—è –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞:** ~100 –ª–µ—Ç –¥–ª—è 8-—Å–∏–º–≤–æ–ª—å–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è

### –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –ë–î:**
```typescript
// 1. –°–æ–∑–¥–∞—Ç—å userAccount
const userAccount = await storage.createUserAccount({
  email: validatedData.email,
  passwordHash: passwordHash,
  emailVerified: false  // –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
});

// 2. –°–æ–∑–¥–∞—Ç—å userProfile
await storage.createUserProfile({
  userId: userAccount.id,
  firstName: null,
  lastName: null
});
```

### –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (64 hex —Å–∏–º–≤–æ–ª–∞)
const plainToken = crypto.randomBytes(32).toString('hex');

// –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
const hashedToken = await bcrypt.hash(plainToken, 12);

// –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 24 —á–∞—Å–∞
const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);

await storage.updateUserAccount(userAccount.id, {
  emailVerificationToken: hashedToken,
  emailVerificationExpires: expiresAt
});
```

**–í–∞–∂–Ω–æ:**
- –í –ë–î —Ö—Ä–∞–Ω–∏—Ç—Å—è **—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π** —Ç–æ–∫–µ–Ω
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **plain** —Ç–æ–∫–µ–Ω
- –¢–æ–∫–µ–Ω —É–Ω–∏–∫–∞–ª–µ–Ω –∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π

### –®–∞–≥ 7: –û—Ç–ø—Ä–∞–≤–∫–∞ email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
const verificationUrl = `${APP_URL}/verify-email?token=${plainToken}&email=${email}`;

await sendEmail({
  to: userAccount.email,
  template: emailVerificationTemplate,
  data: {
    senderName: 'ResCrub',
    recipientName: userAccount.email.split('@')[0],
    verificationUrl: verificationUrl
  },
  userId: userAccount.id,
  category: 'email_verification'
});
```

**Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑:**
- SMTP: Mailganer.ru (api.samotpravil.ru:1126)
- –î–æ–º–µ–Ω: mailone.rescrub.ru
- From: noreply@mailone.rescrub.ru
- Reply-To: support@rescrub.ru

### –®–∞–≥ 8: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

```typescript
res.status(201).json({
  success: true,
  message: "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
  userId: userAccount.id
});
```

**–í development mode** –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è:
```typescript
{
  verificationUrl: "http://localhost:5000/verify-email?token=..."
}
```

---

## üîë –ü–†–û–¶–ï–°–° –í–•–û–î–ê

### –®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ

**Frontend (`client/src/pages/login.tsx`):**
```typescript
const form = useForm({
  resolver: zodResolver(loginSchema),
  defaultValues: {
    email: "",
    password: ""
  }
});
```

### –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**POST `/api/auth/login`**

**Rate Limiting (–°–¢–†–û–ì–ò–ô):**
- –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ –∑–∞ 15 –º–∏–Ω—É—Ç
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ IP + email
- –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫

### –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
const validatedData = loginSchema.parse(req.body);

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
const user = await storage.getUserByEmail(validatedData.email);

if (!user || !user.passwordHash) {
  // ‚ö†Ô∏è –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  return res.status(401).json({
    message: "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
  });
}
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è

```typescript
// bcrypt.compare - constant-time —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç timing attack)
const isValidPassword = await bcrypt.compare(
  validatedData.password,
  user.passwordHash
);

if (!isValidPassword) {
  return res.status(401).json({
    message: "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å"  // –¢–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!
  });
}
```

**–í–∞–∂–Ω–æ:** –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –≤—Å–µ—Ö —Å–ª—É—á–∞–µ–≤:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
- –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚Üí "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å"

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email

```typescript
if (!user.emailVerified) {
  return res.status(403).json({
    success: false,
    message: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –¥–ª—è –≤—Ö–æ–¥–∞",
    needsVerification: true
  });
}
```

**–ï—Å–ª–∏ email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω:**
- –í—Ö–æ–¥ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –ø–∏—Å—å–º–∞

### –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Å—Å–∏—é
req.session.userId = user.id;
req.session.email = user.email;

// ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –Ø–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
req.session.save((err) => {
  if (err) {
    return res.status(500).json({
      message: "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏"
    });
  }
  
  // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
  res.json({
    success: true,
    message: "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ",
    user: {
      id: user.id,
      email: user.email,
      emailVerified: user.emailVerified,
      isAdmin: user.isAdmin
    }
  });
});
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `req.session`
2. Session ID –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ PostgreSQL —Ç–∞–±–ª–∏—Ü—É `sessions`
3. Cookie `connect.sid` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
4. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–æ—Ç cookie –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 7: Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```typescript
// AuthContext –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
setUser({
  id: data.user.id,
  email: data.user.email,
  isAdmin: data.user.isAdmin
});

// –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard
navigate('/app/dashboard');
```

---

## üìß EMAIL –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

#### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç email

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–∏—Å—å–º–∞:**
```
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email –∞–¥—Ä–µ—Å

–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!

–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–∞—à–µ–≥–æ email –∞–¥—Ä–µ—Å–∞:

[–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å Email]
‚Üì
https://rescrub.replit.app/verify-email?token=abc123...&email=user@example.com

–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 24 —á–∞—Å–∞.
```

#### 2. –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ

**Frontend (`client/src/pages/verify-email.tsx`):**
```typescript
// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
const params = new URLSearchParams(location.search);
const token = params.get('token');
const email = params.get('email');

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
useEffect(() => {
  verifyEmail({ token, email });
}, []);
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**POST `/api/auth/verify-email`**

```typescript
// 1. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const user = await storage.getUserByEmail(email);

if (!user || !user.emailVerificationToken) {
  return res.status(400).json({
    message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
  });
}

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
if (user.emailVerificationExpires < new Date()) {
  return res.status(400).json({
    message: "–¢–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏—Å—Ç–µ–∫"
  });
}

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ (bcrypt.compare - constant-time)
const isValidToken = await bcrypt.compare(
  token,
  user.emailVerificationToken
);

if (!isValidToken) {
  return res.status(400).json({
    message: "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
  });
}

// 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email –∏ –æ—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞
await storage.updateUserAccount(user.id, {
  emailVerified: true,
  emailVerificationToken: null,
  emailVerificationExpires: null
});
```

#### 4. –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

```typescript
res.json({
  success: true,
  message: "Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ"
});
```

**Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏"
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã

### –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞

**POST `/api/auth/resend-verification`**

**Rate Limiting:**
- –ú–∞–∫—Å–∏–º—É–º 3 –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Å
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î (—Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º)
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ email
4. –ù–æ–≤—ã–π —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: +24 —á–∞—Å–∞

---

## üåê OAUTH –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –°—Ç–∞—Ç—É—Å | Client ID | PKCE |
|-----------|--------|-----------|------|
| **Replit Auth** | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π | –î–∞ |
| **VK ID** | ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–µ–Ω | –¢—Ä–µ–±—É–µ—Ç—Å—è | –î–∞ |
| **Yandex ID** | ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–µ–Ω | –¢—Ä–µ–±—É–µ—Ç—Å—è | –ù–µ—Ç |
| **Sberbank ID** | üìã –ì–æ—Ç–æ–≤ | –¢—Ä–µ–±—É–µ—Ç—Å—è | –î–∞ |
| **Tinkoff ID** | üìã –ì–æ—Ç–æ–≤ | –¢—Ä–µ–±—É–µ—Ç—Å—è | –î–∞ |
| **ESIA (–ì–æ—Å—É—Å–ª—É–≥–∏)** | üìã –ì–æ—Ç–æ–≤ | –¢—Ä–µ–±—É–µ—Ç—Å—è | –î–∞ |

### –ü—Ä–æ—Ü–µ—Å—Å OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

#### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ VK"

**Frontend:**
```typescript
<Button onClick={() => window.location.href = '/api/oauth/vk'}>
  –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ VK ID
</Button>
```

#### 2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**GET `/api/oauth/:provider`**

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è secure state + PKCE
const oauthState = await generateOAuthState(provider, {
  redirectTo: '/app/dashboard',
  usePKCE: true
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ state –≤ —Å–µ—Å—Å–∏–∏
req.session.oauthStates = {
  [oauthState.state]: oauthState
};

// –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ authorization URL
const authUrl = buildAuthorizationUrl({
  clientId: config.clientId,
  redirectUri: config.redirectUri,
  scope: config.scope,
  state: oauthState.state,
  nonce: oauthState.nonce,
  codeChallenge: oauthState.codeChallenge,
  codeChallengeMethod: 'S256'
});

// Redirect –Ω–∞ VK/Yandex/etc
res.redirect(authUrl);
```

#### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –Ω–∞ VK

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º—É —Å–æ–≥–ª–∞—Å–∏—è VK
- –í—ã–±–∏—Ä–∞–µ—Ç, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–∏—Ç—å
- –ù–∞–∂–∏–º–∞–µ—Ç "–†–∞–∑—Ä–µ—à–∏—Ç—å"

#### 4. Callback –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**GET `/api/oauth/:provider/callback`**

```typescript
// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ state (–∑–∞—â–∏—Ç–∞ –æ—Ç CSRF)
const storedState = req.session.oauthStates?.[state];
if (!storedState) {
  return res.redirect('/login?error=invalid_state');
}

// 2. –û–±–º–µ–Ω code –Ω–∞ access_token
const tokenResponse = await exchangeCodeForToken({
  code: req.query.code,
  codeVerifier: storedState.codeVerifier,
  redirectUri: config.redirectUri
});

// 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
const userInfo = await fetchUserInfo(tokenResponse.access_token);

// 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)
const extractedUser = extractUserInfo(provider, userInfo);
```

#### 5. –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞

```typescript
// –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
let userAccount = await storage.getUserAccountByEmail(extractedUser.email);

if (!userAccount) {
  // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  userAccount = await storage.createUserAccount({
    email: extractedUser.email,
    emailVerified: true,  // OAuth email —É–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
    passwordHash: null    // OAuth –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä–æ–ª—å
  });
  
  await storage.createUserProfile({
    userId: userAccount.id,
    firstName: extractedUser.firstName,
    lastName: extractedUser.lastName
  });
} else {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (!userAccount.emailVerified) {
    await storage.updateUserAccount(userAccount.id, {
      emailVerified: true
    });
  }
}
```

#### 6. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```typescript
req.session.userId = userAccount.id;
req.session.email = userAccount.email;

req.session.save((err) => {
  if (err) {
    return res.redirect('/login?error=session_failed');
  }
  
  // Redirect –Ω–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  res.redirect(storedState.redirectTo || '/app/dashboard');
});
```

---

## üç™ SESSION MANAGEMENT

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Å—Å–∏–π

**Backend (`server/index.ts` –∏ `server/replitAuth.ts`):**

```typescript
import session from 'express-session';
import connectPg from 'connect-pg-simple';

const PgStore = connectPg(session);

const sessionStore = new PgStore({
  conString: process.env.DATABASE_URL,
  createTableIfMissing: false,
  ttl: 7 * 24 * 60 * 60 * 1000,  // 1 –Ω–µ–¥–µ–ª—è
  tableName: 'sessions'
});

app.use(session({
  secret: process.env.SESSION_SECRET,
  store: sessionStore,
  resave: false,
  saveUninitialized: true,
  name: 'connect.sid',
  cookie: {
    httpOnly: true,      // JavaScript –Ω–µ –º–æ–∂–µ—Ç —É–∫—Ä–∞—Å—Ç—å
    secure: false,       // false –¥–ª—è dev, true –¥–ª—è prod
    sameSite: 'lax',     // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
    maxAge: 7 * 24 * 60 * 60 * 1000
  }
}));
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–µ—Å—Å–∏–∏

#### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (Login)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è                                ‚îÇ
‚îÇ     req.session.userId = user.id                        ‚îÇ
‚îÇ     req.session.email = user.email                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. req.session.save()                                  ‚îÇ
‚îÇ     - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è Session ID                           ‚îÇ
‚îÇ     - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ PostgreSQL                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. Set-Cookie header                                   ‚îÇ
‚îÇ     connect.sid=s%3Axxx; HttpOnly; Path=/; SameSite=Lax ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. –ë—Ä–∞—É–∑–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç cookie                            ‚îÇ
‚îÇ     –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –∫–∞–∂–¥—ã–º –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å)

```typescript
// Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –ß–∏—Ç–∞–µ—Ç cookie 'connect.sid'
// 2. –ò—â–µ—Ç —Å–µ—Å—Å–∏—é –≤ PostgreSQL
// 3. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ req.session
// 4. –î–æ—Å—Ç—É–ø–Ω—ã: req.session.userId, req.session.email
```

#### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ PostgreSQL

**–¢–∞–±–ª–∏—Ü–∞ `sessions`:**
```sql
sid         | sess                          | expire
------------|-------------------------------|-------------------
abc123...   | {"cookie": {...},             | 2025-11-06 15:00:00
            |  "userId": "uuid-here",       |
            |  "email": "user@example.com"} |
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:**
- –°–µ—Å—Å–∏–∏ —Å –∏—Å—Ç–µ–∫—à–∏–º `expire` —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ò–Ω–¥–µ–∫—Å –Ω–∞ `expire` –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—á–∏—Å—Ç–∫–∏

#### 4. Logout

```typescript
app.post('/api/auth/logout', isAuthenticated, async (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).json({
        message: "–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞"
      });
    }
    
    res.clearCookie('connect.sid');
    res.json({
      success: true,
      message: "–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    });
  });
});
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. `req.session.destroy()` —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ PostgreSQL
2. `res.clearCookie()` —É–¥–∞–ª—è–µ—Ç cookie –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ–ª—å—à–µ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –†–û–£–¢–û–í

### Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

#### 1. isEmailAuthenticated (–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

```typescript
function isEmailAuthenticated(req: any, res: any, next: any) {
  if (req.session?.userId) {
    return next();  // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
  }
  res.status(401).json({ 
    success: false,
    message: "Unauthorized" 
  });
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
app.get('/api/dashboard', isEmailAuthenticated, async (req, res) => {
  // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const userId = req.session.userId;
  // ...
});
```

#### 2. isAdmin (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)

```typescript
async function isAdmin(req: any, res: any, next: any) {
  const userId = req.session?.userId;
  
  if (!userId) {
    return res.status(401).json({ 
      message: "Unauthorized" 
    });
  }
  
  const userAccount = await storage.getUserAccountById(userId);
  
  if (!userAccount || !userAccount.isAdmin) {
    return res.status(403).json({
      message: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
    });
  }
  
  req.adminUser = userAccount;
  next();
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
app.get('/api/admin/users', isAdmin, async (req, res) => {
  // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
  const adminUser = req.adminUser;
  // ...
});
```

#### 3. requireSuperAdmin (—Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

```typescript
async function requireSuperAdmin(req: any, res: any, next: any) {
  const userId = req.session?.userId;
  
  if (!userId) {
    return res.status(401).json({ 
      message: "Unauthorized" 
    });
  }
  
  const userAccount = await storage.getUserAccountById(userId);
  
  if (!userAccount || userAccount.adminRole !== 'superadmin') {
    return res.status(403).json({
      message: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
    });
  }
  
  req.adminUser = userAccount;
  req.adminIp = req.ip || 'unknown';
  req.adminUserAgent = req.headers['user-agent'] || 'unknown';
  next();
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
app.delete('/api/admin/delete-all-data', requireSuperAdmin, async (req, res) => {
  // –¢–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –∫—Ç–æ, –∫–æ–≥–¥–∞, –æ—Ç–∫—É–¥–∞
  console.log('CRITICAL ACTION:', {
    admin: req.adminUser.email,
    ip: req.adminIp,
    userAgent: req.adminUserAgent,
    action: 'delete-all-data'
  });
  // ...
});
```

### Frontend –∑–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤

**AuthGuard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
```typescript
function AuthGuard({ children }: { children: React.ReactNode }) {
  const { user, isLoading } = useAuth();
  const [location, setLocation] = useLocation();

  if (isLoading) {
    return <LoadingSpinner />;
  }

  if (!user) {
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∂–µ–ª–∞–µ–º—ã–π URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
    const returnUrl = location;
    setLocation(`/login?redirect=${returnUrl}`);
    return null;
  }

  return <>{children}</>;
}
```

**AdminGuard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
```typescript
function AdminGuard({ children }: { children: React.ReactNode }) {
  const { user, isLoading } = useAuth();
  const [location, setLocation] = useLocation();

  if (isLoading) {
    return <LoadingSpinner />;
  }

  if (!user) {
    setLocation('/login');
    return null;
  }

  if (!user.isAdmin) {
    setLocation('/app/dashboard');
    toast.error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
    return null;
  }

  return <>{children}</>;
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–æ—É—Ç–∏–Ω–≥–µ:**
```typescript
<Route path="/app/*">
  <AuthGuard>
    <Route path="/dashboard" component={Dashboard} />
    <Route path="/profile" component={Profile} />
  </AuthGuard>
</Route>

<Route path="/admin/*">
  <AdminGuard>
    <Route path="/users" component={AdminUsers} />
    <Route path="/settings" component={AdminSettings} />
  </AdminGuard>
</Route>
```

---

## üíæ DATABASE –°–•–ï–ú–ê

### –¢–∞–±–ª–∏—Ü–∞: userAccounts

**–û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```typescript
export const userAccounts = pgTable("user_accounts", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  email: varchar("email", { length: 255 }).notNull().unique(),
  passwordHash: varchar("password_hash", { length: 255 }),
  emailVerified: boolean("email_verified").default(false).notNull(),
  emailVerificationToken: varchar("email_verification_token", { length: 255 }),
  emailVerificationExpires: timestamp("email_verification_expires"),
  isAdmin: boolean("is_admin").default(false).notNull(),
  adminRole: varchar("admin_role", { length: 50 }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

**–ü–æ–ª—è:**
- `id` - UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Primary Key)
- `email` - Email –∞–¥—Ä–µ—Å (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `passwordHash` - bcrypt —Ö–µ—à –ø–∞—Ä–æ–ª—è (NULL –¥–ª—è OAuth)
- `emailVerified` - Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω? (boolean)
- `emailVerificationToken` - –•–µ—à —Ç–æ–∫–µ–Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `emailVerificationExpires` - –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
- `isAdmin` - –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `adminRole` - –†–æ–ª—å –∞–¥–º–∏–Ω–∞ ('admin' | 'superadmin')
- `createdAt` - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
- `updatedAt` - –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞: userProfiles

**–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```typescript
export const userProfiles = pgTable("user_profiles", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  userId: varchar("user_id").notNull()
    .references(() => userAccounts.id, { onDelete: 'cascade' }),
  firstName: varchar("first_name", { length: 100 }),
  lastName: varchar("last_name", { length: 100 }),
  phoneNumber: varchar("phone_number", { length: 20 }),
  dateOfBirth: date("date_of_birth"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull()
});
```

**–°–≤—è–∑—å:** One-to-One —Å `userAccounts`

### –¢–∞–±–ª–∏—Ü–∞: sessions

**Session store –¥–ª—è express-session**

```typescript
export const sessions = pgTable("sessions", {
  sid: varchar("sid").primaryKey(),
  sess: jsonb("sess").notNull(),
  expire: timestamp("expire", { mode: "date" }).notNull()
});
```

**–ò–Ω–¥–µ–∫—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏:**
```typescript
export const sessionsExpireIdx = index("IDX_session_expire")
  .on(sessions.expire);
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `sess` (JSONB):**
```json
{
  "cookie": {
    "originalMaxAge": 604800000,
    "expires": "2025-11-06T15:00:00.000Z",
    "httpOnly": true,
    "path": "/"
  },
  "userId": "uuid-here",
  "email": "user@example.com",
  "oauthStates": {}
}
```

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### Implemented Security Measures

#### 1. Password Security
- ‚úÖ **bcrypt hashing** - 12 rounds (200ms, ~100 years to crack)
- ‚úÖ **No password limits** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ 128 —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ **Password complexity** - regex –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ **No password logging** - –ø–∞—Ä–æ–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

#### 2. Token Security
- ‚úÖ **Cryptographically secure** - crypto.randomBytes(32)
- ‚úÖ **Hashed storage** - —Ç–æ–∫–µ–Ω—ã —Ö–µ—à–∏—Ä—É—é—Ç—Å—è –≤ –ë–î
- ‚úÖ **Expiration** - 24 —á–∞—Å–∞ –¥–ª—è email —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ **Timing-safe comparison** - bcrypt.compare (constant-time)
- ‚úÖ **HMAC tokens** - –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

#### 3. Session Security
- ‚úÖ **PostgreSQL store** - —Å–µ—Å—Å–∏–∏ –≤ –ë–î, –Ω–µ –≤ –ø–∞–º—è—Ç–∏
- ‚úÖ **httpOnly cookies** - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS
- ‚úÖ **secure in production** - —Ç–æ–ª—å–∫–æ HTTPS
- ‚úÖ **SameSite=lax** - –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF
- ‚úÖ **Auto cleanup** - —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ —É–¥–∞–ª—è—é—Ç—Å—è

#### 4. Rate Limiting
- ‚úÖ **Global limiter** - 100 req/15min –Ω–∞ /api/*
- ‚úÖ **Login limiter** - 5 –ø–æ–ø—ã—Ç–æ–∫/15min
- ‚úÖ **Register limiter** - 3 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/—á–∞—Å
- ‚úÖ **Resend limiter** - 3 –æ—Ç–ø—Ä–∞–≤–∫–∏/—á–∞—Å
- ‚úÖ **IP + email blocking** - —Ç–æ—á–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### 5. Input Validation
- ‚úÖ **Zod schemas** - —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ **Email format** - RFC –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ **String length limits** - –∑–∞—â–∏—Ç–∞ –æ—Ç DoS
- ‚úÖ **SQL Injection proof** - Drizzle ORM prepared statements
- ‚úÖ **XSS protection** - DOMPurify sanitization

#### 6. Error Messages
- ‚úÖ **Generic errors** - –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –¥–µ—Ç–∞–ª–∏
- ‚úÖ **Same message** - –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ –≤—Ö–æ–¥–∞
- ‚úÖ **No stack traces** - –≤ production
- ‚úÖ **No user enumeration** - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ email

#### 7. Headers & CORS
- ‚úÖ **Helmet.js** - security headers
- ‚úÖ **CSP** - Content Security Policy
- ‚úÖ **X-Frame-Options** - –∑–∞—â–∏—Ç–∞ –æ—Ç clickjacking
- ‚úÖ **HSTS** - Strict-Transport-Security

#### 8. OAuth Security
- ‚úÖ **State parameter** - CSRF protection
- ‚úÖ **PKCE** - –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ **Nonce** - replay attack protection
- ‚úÖ **Secure state storage** - –≤ session

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|---------|----------|--------|
| **Password rounds** | 12 | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| **Token length** | 64 hex chars | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| **Session TTL** | 7 –¥–Ω–µ–π | ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ |
| **Login rate limit** | 5/15min | ‚úÖ –°—Ç—Ä–æ–≥–æ |
| **Register rate limit** | 3/hour | ‚úÖ –°—Ç—Ä–æ–≥–æ |
| **Email verification** | 24 —á–∞—Å–∞ | ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç |

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

| –û–ø–µ—Ä–∞—Ü–∏—è | –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è | –û—Ü–µ–Ω–∫–∞ |
|----------|---------------|--------|
| **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** | ~2-3 —Å–µ–∫—É–Ω–¥—ã | ‚úÖ –ë—ã—Å—Ç—Ä–æ |
| **–í—Ö–æ–¥** | ~500ms | ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ |
| **Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è** | ~200ms | ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ |
| **OAuth callback** | ~1-2 —Å–µ–∫—É–Ω–¥—ã | ‚úÖ –ü—Ä–∏–µ–º–ª–µ–º–æ |
| **Logout** | ~100ms | ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ |

---

## üîÑ –ü–†–û–¶–ï–°–° –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ü–ê–†–û–õ–Ø

### (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)

–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å:

1. **–ó–∞–ø—Ä–æ—Å —Å–±—Ä–æ—Å–∞:**
   - POST `/api/auth/forgot-password`
   - Rate limit: 3 –∑–∞–ø—Ä–æ—Å–∞/—á–∞—Å
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è reset —Ç–æ–∫–µ–Ω–∞ (bcrypt hashed)

2. **Email —Å —Å—Å—ã–ª–∫–æ–π:**
   - –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 1 —á–∞—Å
   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Ç–æ–∫–µ–Ω

3. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è:**
   - POST `/api/auth/reset-password`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ passwordHash

4. **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π:**
   - Logout —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   - –ù–æ–≤—ã–π –≤—Ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω

---

## üìù CHANGELOG

- **2025-10-30**: –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã
- **2025-09-15**: Production-ready email authentication
- **2025-09-16**: Mailganer.ru –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **2025-09-19**: OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (VK, Yandex)
- **2025-09-20**: Admin –ø–∞–Ω–µ–ª—å —Å –∑–∞—â–∏—Ç–æ–π —Ä–æ—É—Ç–æ–≤

---

## üéØ –ò–¢–û–ì–ò

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Email/Password —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** - –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
2. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ö–æ–¥** - bcrypt, rate limiting, session management
3. **OAuth –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - Replit, VK, Yandex (–≥–æ—Ç–æ–≤–æ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)
4. **Email —Å–∏—Å—Ç–µ–º–∞** - Mailganer.ru SMTP
5. **–ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤** - middleware –Ω–∞ frontend –∏ backend
6. **Admin –ø–∞–Ω–µ–ª—å** - –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
7. **Session store** - PostgreSQL —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç OWASP Top 10
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç timing attacks
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL injection
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç brute force
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

### üìà –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:

**95% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏**

–û—Å—Ç–∞–ª–æ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:
- [ ] –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
- [ ] 2FA (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] Email –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ
