# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Robokassa –≤ ResCrub

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–æ–±–∑–æ—Ä-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
2. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ñ–∞–π–ª–æ–≤)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
5. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ Robokassa](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ª–∏—á–Ω–æ–≥–æ-–∫–∞–±–∏–Ω–µ—Ç–∞-robokassa)
6. [–ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã](#–ø—Ä–æ—Ü–µ—Å—Å-–æ–ø–ª–∞—Ç—ã)
7. [–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏](#–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ-–ø–ª–∞—Ç–µ–∂–∏)
8. [–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-webhook-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
9. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## –û–±–∑–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–í –ø—Ä–æ–µ–∫—Ç–µ ResCrub —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π Robokassa –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- ‚úÖ –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π (recurring payments)
- ‚úÖ –û–ø–ª–∞—Ç—ã –±–∞–ª–ª–∞–º–∏ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞)
- ‚úÖ –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã (–±–∞–ª–ª—ã + Robokassa)
- ‚úÖ Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–µ–π

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **RobokassaClient** (`server/robokassa.ts`) - –∫–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
- **Webhook handlers** (`server/routes.ts`) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **SubscriptionManager** (`server/subscription-manager.ts`) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
- **Database schema** (`shared/schema.ts`) - —Ç–∞–±–ª–∏—Ü—ã payments –∏ subscriptions

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
# Robokassa Production (–ë–æ–µ–≤–æ–π —Ä–µ–∂–∏–º)
ROBOKASSA_MERCHANT_LOGIN=your_merchant_login
ROBOKASSA_PASSWORD_1=your_password_1
ROBOKASSA_PASSWORD_2=your_password_2

# Robokassa Test (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
ROBOKASSA_TEST_MODE=true
ROBOKASSA_TEST_PASSWORD_1=your_test_password_1
ROBOKASSA_TEST_PASSWORD_2=your_test_password_2
```

### –ì–¥–µ –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è:

1. **ROBOKASSA_MERCHANT_LOGIN** - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ (Merchant Login)
   - –î–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Robokassa ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

2. **ROBOKASSA_PASSWORD_1** - –ø–∞—Ä–æ–ª—å ‚Ññ1 –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ –ø–ª–∞—Ç–µ–∂–∞
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –õ–ö Robokassa ‚Üí –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ü–∞—Ä–æ–ª—å #1

3. **ROBOKASSA_PASSWORD_2** - –ø–∞—Ä–æ–ª—å ‚Ññ2 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –õ–ö Robokassa ‚Üí –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ü–∞—Ä–æ–ª—å #2

4. **TEST-—Ä–µ–∂–∏–º –ø–∞—Ä–æ–ª–∏** - –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º"

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```bash
# –£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
‚úÖ Robokassa client initialized

# –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
‚ö†Ô∏è Robokassa credentials not found. Payment processing will be disabled.
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
server/
‚îú‚îÄ‚îÄ robokassa.ts              # RobokassaClient - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ routes.ts                 # Webhook endpoints + API –æ–ø–ª–∞—Ç—ã
‚îú‚îÄ‚îÄ subscription-manager.ts   # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
‚îî‚îÄ‚îÄ storage.ts                # Database –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π

shared/
‚îî‚îÄ‚îÄ schema.ts                 # Drizzle —Å—Ö–µ–º—ã: payments, subscriptions

client/src/pages/
‚îî‚îÄ‚îÄ Subscription.tsx          # UI —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### Database Schema

#### –¢–∞–±–ª–∏—Ü–∞ `subscriptions`
```typescript
export const subscriptions = pgTable("subscriptions", {
  id: varchar("id").primaryKey(),
  userId: varchar("user_id").notNull(),
  planId: varchar("plan_id").notNull(),
  status: varchar("status"), // 'pending' | 'active' | 'cancelled' | 'expired'
  currentPeriodStart: timestamp("current_period_start"),
  currentPeriodEnd: timestamp("current_period_end"),
  robokassaInvoiceId: varchar("robokassa_invoice_id").unique(), // ID –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
  createdAt: timestamp("created_at").defaultNow(),
});
```

#### –¢–∞–±–ª–∏—Ü–∞ `payments`
```typescript
export const payments = pgTable("payments", {
  id: varchar("id").primaryKey(),
  subscriptionId: varchar("subscription_id").notNull(),
  userId: varchar("user_id").notNull(),
  amount: integer("amount").notNull(), // –≤ —Ä—É–±–ª—è—Ö
  currency: varchar("currency").default("RUB"),
  status: varchar("status"), // 'pending' | 'paid' | 'failed' | 'refunded'
  paymentMethod: varchar("payment_method"), // 'card' | 'wallet' | 'sberbank'
  robokassaInvoiceId: varchar("robokassa_invoice_id").unique(),
  parentInvoiceId: varchar("parent_invoice_id"), // –¥–ª—è recurring –ø–ª–∞—Ç–µ–∂–µ–π
  isRecurring: boolean("is_recurring").default(false),
  paidAt: timestamp("paid_at"),
  failedAt: timestamp("failed_at"),
  createdAt: timestamp("created_at").defaultNow(),
});
```

### RobokassaClient API

#### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
```typescript
import { robokassaClient } from './robokassa';

const paymentUrl = robokassaClient.createPaymentUrl({
  invoiceId: 'sub_user123_1234567890',
  amount: 990, // –≤ —Ä—É–±–ª—è—Ö
  description: '–ü–æ–¥–ø–∏—Å–∫–∞ Premium –Ω–∞ 1 –º–µ—Å—è—Ü',
  userEmail: 'user@example.com',
  isRecurring: false, // true –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ —Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º
});

// –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ paymentUrl
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (recurring)
```typescript
const recurringResult = await robokassaClient.createRecurringPayment({
  invoiceId: 'sub_user123_1234567891', // –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
  previousInvoiceId: 'sub_user123_1234567890', // ID –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
  amount: 990,
  description: '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ Premium',
});

if (recurringResult.success) {
  console.log('Recurring payment created:', recurringResult.invoiceId);
} else {
  console.error('Recurring payment failed:', recurringResult.error);
}
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook –ø–æ–¥–ø–∏—Å–∏
```typescript
app.post('/api/webhooks/robokassa/result', async (req, res) => {
  const parsedData = robokassaClient.parseWebhookData(req.body);
  
  if (!parsedData || !parsedData.isValid) {
    return res.status(400).send('Invalid signature');
  }
  
  const { invoiceId, amount, paymentMethod } = parsedData;
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
});
```

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ Robokassa

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [robokassa.ru](https://robokassa.ru)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"** ‚Üí **"–ú–æ–∏ –º–∞–≥–∞–∑–∏–Ω—ã"**
3. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω"**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–≥–∞–∑–∏–Ω–µ

### 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–í —Ä–∞–∑–¥–µ–ª–µ **"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"** —É–∫–∞–∂–∏—Ç–µ:

#### Result URL (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
```
https://yourdomain.com/api/webhooks/robokassa/result
```
**–í–∞–∂–Ω–æ:** Robokassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ—Ä—Ç—ã 80 (HTTP) –∏ 443 (HTTPS)

#### Success URL
```
https://yourdomain.com/api/webhooks/robokassa/success
```

#### Fail URL
```
https://yourdomain.com/api/webhooks/robokassa/fail
```

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- **–ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:** POST
- **–ö–æ–¥–∏—Ä–æ–≤–∫–∞:** UTF-8
- **–ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏:** MD5
- **–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:** –†—É—Å—Å–∫–∏–π (ru)

### 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π

1. **–ü–∞—Ä–æ–ª—å #1** - –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
   - –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–∞—Ä–æ–ª—å #1"
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `ROBOKASSA_PASSWORD_1`

2. **–ü–∞—Ä–æ–ª—å #2** - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö
   - –ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–∞—Ä–æ–ª—å #2"
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `ROBOKASSA_PASSWORD_2`

### 4. –í–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π (Recurring)

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"** ‚Üí **"Recurring –ø–ª–∞—Ç–µ–∂–∏"**
2. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–í–∞–∂–Ω–æ:** –ë–µ–∑ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Recurring –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥—É—Ç!

### 5. –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**:
1. –í–∫–ª—é—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –º–∞–≥–∞–∑–∏–Ω–∞
2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ #1 –∏ #2
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `ROBOKASSA_TEST_PASSWORD_1` –∏ `ROBOKASSA_TEST_PASSWORD_2`
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `ROBOKASSA_TEST_MODE=true`

---

## –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### –ü–æ—à–∞–≥–æ–≤—ã–π flow –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏

#### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏

Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å:
```typescript
// client/src/pages/Subscription.tsx
const response = await apiRequest('/api/subscription', {
  method: 'POST',
  body: JSON.stringify({ planId: selectedPlan.id }),
});
```

#### 2. Backend —Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–ª–∞—Ç–µ–∂

```typescript
// server/routes.ts - POST /api/subscription
app.post('/api/subscription', isEmailAuthenticated, async (req, res) => {
  const { planId } = req.body;
  const userId = req.session.userId!;
  
  // 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userPoints = await storage.getUserPoints(userId);
  const plan = await storage.getSubscriptionPlanById(planId);
  const planPriceRubles = plan.price;
  
  // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∏—Ç –ª–∏ –±–∞–ª–ª–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–ø–ª–∞—Ç—ã
  const canPayWithPoints = userPoints >= planPriceRubles;
  const pointsToUse = canPayWithPoints ? planPriceRubles : 0;
  const remainingAmountToPay = canPayWithPoints ? 0 : planPriceRubles;
  
  // 3. –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
  if (pointsToUse > 0) {
    await storage.deductUserPoints(userId, pointsToUse);
  }
  
  // 4. –°–æ–∑–¥–∞–µ–º invoice ID
  const invoiceId = `sub_${userId}_${Date.now()}`;
  
  // 5. –°–æ–∑–¥–∞–µ–º subscription
  const subscription = await storage.createSubscription({
    userId,
    planId,
    status: 'pending',
    robokassaInvoiceId: invoiceId,
  });
  
  // 6. –°–æ–∑–¥–∞–µ–º payment
  const payment = await storage.createPayment({
    subscriptionId: subscription.id,
    userId,
    amount: remainingAmountToPay,
    currency: plan.currency,
    robokassaInvoiceId: invoiceId,
    isRecurring: false,
  });
  
  // 7. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º URL –æ–ø–ª–∞—Ç—ã –∏–ª–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
  if (remainingAmountToPay > 0) {
    // –ù—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Robokassa
    const paymentUrl = robokassaClient.createPaymentUrl({
      invoiceId,
      amount: remainingAmountToPay,
      description: `–ü–æ–¥–ø–∏—Å–∫–∞ ${plan.displayName}`,
      userEmail: userAccount?.email,
      isRecurring: false,
    });
    
    res.json({
      subscription,
      payment,
      paymentUrl, // Frontend –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —ç—Ç–æ—Ç URL
      pointsUsed: pointsToUse,
      remainingAmount: remainingAmountToPay,
    });
  } else {
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω–æ –±–∞–ª–ª–∞–º–∏ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ä–∞–∑—É
    await storage.updateSubscription(subscription.id, { status: 'active' });
    await storage.updatePayment(payment.id, { status: 'paid', paymentMethod: 'points' });
    
    res.json({
      subscription,
      payment,
      paymentUrl: null,
      fullyPaidWithPoints: true,
    });
  }
});
```

#### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ Robokassa

Frontend –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `paymentUrl`:
```typescript
if (response.paymentUrl) {
  window.location.href = response.paymentUrl;
}
```

#### 4. Robokassa –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã ‚Üí Robokassa —Å–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–Ω—å–≥–∏ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook

#### 5. Backend –ø–æ–ª—É—á–∞–µ—Ç Result URL webhook

```typescript
// server/routes.ts - POST /api/webhooks/robokassa/result
app.post('/api/webhooks/robokassa/result', async (req, res) => {
  // 1. –ü–∞—Ä—Å–∏–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
  const parsedData = robokassaClient.parseWebhookData(req.body);
  if (!parsedData || !parsedData.isValid) {
    return res.status(400).send('Invalid signature');
  }
  
  const { invoiceId, amount, paymentMethod } = parsedData;
  
  // 2. –ù–∞—Ö–æ–¥–∏–º –ø–ª–∞—Ç–µ–∂
  const payment = await storage.getPaymentByInvoiceId(invoiceId);
  
  // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
  await storage.updatePayment(payment.id, {
    status: 'paid',
    paidAt: new Date(),
    paymentMethod,
  });
  
  // 4. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
  const subscription = await storage.getSubscriptionById(payment.subscriptionId);
  const plan = await storage.getSubscriptionPlanById(subscription.planId);
  
  const now = new Date();
  const currentPeriodEnd = new Date(now);
  currentPeriodEnd.setMonth(currentPeriodEnd.getMonth() + plan.intervalCount);
  
  await storage.updateSubscription(subscription.id, {
    status: 'active',
    currentPeriodStart: now,
    currentPeriodEnd,
  });
  
  // 5. –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã
  await storage.addUserPoints(subscription.userId, 100, '–£—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞');
  
  // 6. –û—Ç–≤–µ—á–∞–µ–º "OK" —á—Ç–æ–±—ã Robokassa –∑–Ω–∞–ª–∞, —á—Ç–æ webhook –æ–±—Ä–∞–±–æ—Ç–∞–Ω
  res.send('OK');
});
```

#### 6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ Success URL

Robokassa –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –≤–∞—à —Å–∞–π—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

---

## –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

ResCrub –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **SubscriptionManager** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫:

#### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

```typescript
// server/index.ts
import { SubscriptionManager } from './subscription-manager';

const subscriptionManager = SubscriptionManager.getInstance();
subscriptionManager.start(); // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

```typescript
// server/subscription-manager.ts
class SubscriptionManager {
  async processRecurringPayments() {
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥–ø–∏—Å–∫–∏, —Å—Ä–æ–∫ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è
    const renewalThreshold = new Date();
    renewalThreshold.setDate(renewalThreshold.getDate() + 3);
    
    const expiringSubscriptions = await storage.getExpiringSubscriptions(renewalThreshold);
    
    for (const subscription of expiringSubscriptions) {
      await this.renewSubscription(subscription);
    }
  }
  
  async renewSubscription(subscription: Subscription) {
    const plan = await storage.getSubscriptionPlanById(subscription.planId);
    const newInvoiceId = `sub_${subscription.userId}_${Date.now()}`;
    
    // 1. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π payment record
    const payment = await storage.createPayment({
      subscriptionId: subscription.id,
      userId: subscription.userId,
      amount: plan.price,
      currency: plan.currency,
      robokassaInvoiceId: newInvoiceId,
      isRecurring: true, // –§–ª–∞–≥ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
      parentInvoiceId: subscription.robokassaInvoiceId, // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂
    });
    
    // 2. –°–æ–∑–¥–∞–µ–º recurring –ø–ª–∞—Ç–µ–∂ –≤ Robokassa
    const recurringResult = await robokassaClient.createRecurringPayment({
      invoiceId: newInvoiceId,
      previousInvoiceId: subscription.robokassaInvoiceId!, // ID –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
      amount: plan.price,
      description: `–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ ${plan.displayName}`,
    });
    
    if (recurringResult.success) {
      // 3. Robokassa –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—à–µ—Ç –¥–µ–Ω—å–≥–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç Result URL webhook
      console.log(`‚úÖ Recurring payment created for subscription ${subscription.id}`);
    } else {
      // 4. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      await sendSubscriptionExpiryNotification(subscription.userId, subscription);
    }
  }
}
```

#### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

1. **–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂** - –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `subscription.robokassaInvoiceId`
2. **–î–æ—á–µ—Ä–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏** - –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π —á–µ—Ä–µ–∑ `parentInvoiceId`
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ** - Robokassa —Å–∞–º–∞ —Å–ø–∏—à–µ—Ç –¥–µ–Ω—å–≥–∏ —Å –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. **Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** - –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è Robokassa –æ—Ç–ø—Ä–∞–≤–∏—Ç webhook –Ω–∞ Result URL

### –£—Å–ª–æ–≤–∏—è –¥–ª—è recurring –ø–ª–∞—Ç–µ–∂–µ–π

- ‚úÖ –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `isRecurring: true`
- ‚úÖ –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Robokassa –≤–∫–ª—é—á–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è Recurring
- ‚úÖ –ö–∞—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç recurring (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∫–∞—Ä—Ç)
- ‚úÖ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã –Ω–µ –∏—Å—Ç–µ–∫

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### Result URL - —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞

**Endpoint:** `POST /api/webhooks/robokassa/result`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
```
OutSum=990.00
InvId=sub_user123_1234567890
SignatureValue=abc123def456...
PaymentMethod=BankCard
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```typescript
app.post('/api/webhooks/robokassa/result', 
  express.raw({ type: 'application/x-www-form-urlencoded' }), 
  async (req, res) => {
    // 1. –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
    const data = new URLSearchParams(req.body.toString());
    const webhookData = Object.fromEntries(data.entries());
    
    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å (–ö–†–ò–¢–ò–ß–ù–û!)
    const parsedData = robokassaClient.parseWebhookData(webhookData);
    if (!parsedData || !parsedData.isValid) {
      return res.status(400).send('Invalid signature');
    }
    
    // 3. –ù–∞—Ö–æ–¥–∏–º –ø–ª–∞—Ç–µ–∂
    const payment = await storage.getPaymentByInvoiceId(parsedData.invoiceId);
    if (!payment) {
      return res.status(404).send('Payment not found');
    }
    
    // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    await storage.updatePayment(payment.id, {
      status: 'paid',
      paidAt: new Date(),
      paymentMethod: parsedData.paymentMethod,
    });
    
    // 5. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    await storage.updateSubscription(payment.subscriptionId, {
      status: 'active',
      currentPeriodStart: new Date(),
      currentPeriodEnd: calculatePeriodEnd(plan),
    });
    
    // 6. –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å—ã
    await storage.addUserPoints(payment.userId, 100, '–£—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞');
    
    // 7. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–µ–º "OK"
    res.send('OK');
  }
);
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:**
- Webhook –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å `200 OK` –∏–ª–∏ `OK` –≤ —Ç–µ–ª–µ
- Robokassa –ø–æ–≤—Ç–æ—Ä–∏—Ç webhook –¥–æ 10 —Ä–∞–∑, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç OK
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### Success URL - —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Endpoint:** `POST /api/webhooks/robokassa/success`

```typescript
app.post('/api/webhooks/robokassa/success', async (req, res) => {
  // –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º - –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Result URL
  console.log('User returned after successful payment');
  res.send('OK');
});
```

### Fail URL - –Ω–µ—É–¥–∞—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞

**Endpoint:** `POST /api/webhooks/robokassa/fail`

```typescript
app.post('/api/webhooks/robokassa/fail', async (req, res) => {
  const { InvId: invoiceId, FailureDescription } = req.body;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
  const payment = await storage.getPaymentByInvoiceId(invoiceId);
  if (payment) {
    await storage.updatePayment(payment.id, {
      status: 'failed',
      failedAt: new Date(),
      failureReason: FailureDescription || 'Payment failed',
    });
  }
  
  res.send('OK');
});
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º

–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º:
```bash
ROBOKASSA_TEST_MODE=true
ROBOKASSA_TEST_PASSWORD_1=test_password_1
ROBOKASSA_TEST_PASSWORD_2=test_password_2
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã

Robokassa –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:

| –ö–∞—Ä—Ç–∞ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------|-----------|
| `4111111111111111` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| `4242424242424242` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| `5555555555554444` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| `0000000000000000` | –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ |

**–°—Ä–æ–∫:** –ª—é–±–æ–π –±—É–¥—É—â–∏–π –º–µ—Å—è—Ü/–≥–æ–¥  
**CVV:** –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã

### 3. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhooks

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **ngrok** –∏–ª–∏ **localtunnel** –¥–ª—è —Ç—É–Ω–Ω–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è localhost:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ngrok
npm install -g ngrok

# –ó–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—è
ngrok http 5000

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://abc123.ngrok.io)
```

–ó–∞—Ç–µ–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Robokassa —É–∫–∞–∂–∏—Ç–µ:
```
Result URL: https://abc123.ngrok.io/api/webhooks/robokassa/result
Success URL: https://abc123.ngrok.io/api/webhooks/robokassa/success
Fail URL: https://abc123.ngrok.io/api/webhooks/robokassa/fail
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhooks
npm run dev

# –õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:
‚úÖ Robokassa result webhook received: { OutSum: '990.00', InvId: 'sub_...' }
‚úÖ Payment updated: paid
‚úÖ Subscription activated
üí∞ Awarded 100 points to user
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏

**–í–°–ï–ì–î–ê** –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–ø–∏—Å—å webhook:
```typescript
const parsedData = robokassaClient.parseWebhookData(webhookData);
if (!parsedData || !parsedData.isValid) {
  return res.status(400).send('Invalid signature');
}
```

### 2. –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

- ‚ùå **–ù–ï –ö–û–ú–ú–ò–¢–¨–¢–ï** –ø–∞—Ä–æ–ª–∏ –≤ Git
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env` —Ñ–∞–π–ª (–¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Replit Secrets –¥–ª—è production

### 3. HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω

Robokassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhooks **—Ç–æ–ª—å–∫–æ –Ω–∞ HTTPS** (–ø–æ—Ä—Ç 443):
- ‚úÖ Production –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ HTTPS
- ‚úÖ –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok

### 4. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å webhooks

Robokassa –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–∏–Ω webhook **–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑**:
```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ –ø–ª–∞—Ç–µ–∂ —É–∂–µ
if (payment.status === 'paid') {
  console.log('Payment already processed');
  return res.send('OK'); // –í—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º OK
}
```

### 5. Timeout –∑–∞—â–∏—Ç–∞

Webhook –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ **30 —Å–µ–∫—É–Ω–¥**:
```typescript
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±—ã—Å—Ç—Ä–æ, —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - –≤ —Ñ–æ–Ω–µ
res.send('OK'); // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—á–∞–µ–º

// –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
await sendEmailNotification(user);
```

---

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–†–µ—à–µ–Ω–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Robokassa (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å HTTPS)
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: Invalid signature

**–†–µ—à–µ–Ω–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `ROBOKASSA_PASSWORD_2`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Robokassa —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º **MD5**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `ROBOKASSA_TEST_MODE`

### –ü—Ä–æ–±–ª–µ–º–∞: Recurring –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏—è:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –õ–ö Robokassa –≤–∫–ª—é—á–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è Recurring
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –±—ã–ª —Å `isRecurring: true`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `subscription.robokassaInvoiceId` —Å–æ—Ö—Ä–∞–Ω–µ–Ω

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å

**–†–µ—à–µ–Ω–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook `/api/webhooks/robokassa/result` –æ—Ç—Ä–∞–±–æ—Ç–∞–ª
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è subscription
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ payment.subscriptionId –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Robokassa
- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://docs.robokassa.ru/
- API Reference: https://docs.robokassa.ru/partner-api/
- –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: https://docs.robokassa.ru/test-mode/

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- Email: support@robokassa.ru
- –¢–µ–ª–µ—Ñ–æ–Ω: 8 (800) 700-11-58
- Telegram: @robokassa_support

### –ö–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ ResCrub
- `server/robokassa.ts` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `server/routes.ts` - webhook handlers
- `server/subscription-manager.ts` - –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- `shared/schema.ts` - database schema

---

## –ß–µ–∫–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞ –≤ production

- [ ] –ü–æ–ª—É—á–µ–Ω—ã –±–æ–µ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ #1 –∏ #2
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–±–µ–∑ TEST_MODE)
- [ ] Result URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ HTTPS –¥–æ–º–µ–Ω
- [ ] Success/Fail URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏: MD5
- [ ] –ú–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏: POST
- [ ] –ö–æ–¥–∏—Ä–æ–≤–∫–∞: UTF-8
- [ ] –í–∫–ª—é—á–µ–Ω Recurring (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –æ—Ç–∫–∞–∑ –≤ –æ–ø–ª–∞—Ç–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ webhooks —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–∞
- [ ] HTTPS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Robokassa –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ. üöÄ
